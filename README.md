## 识别剪力墙和柱
 
图2  结构平面图输入及剪力墙和柱的识别
Fig.2 The input structural layout and the recognition of shear walls and columns
输入的结构平面图中，梁用双实线表示，柱用黑色填充的多边形或圆形表示，剪力墙用黑色填充的多边形表示，如图2(a)所示。首先将输入的结构平面图Img转化为灰度图Imggrey，存储在h×w的矩阵中，其中h为图像的高度方向像素数量，w为图像的宽度方向像素数量，矩阵的每个元素为取值范围0~255的整数值。然后对图像进行高斯核大小为k的高斯模糊处理以模糊双实线，再经过127的阈值过滤掉代表梁的双实线，最终得到代表剪力墙和柱的填充多边形图像Imgsolid，如图2(b)所示。
2.2 识别线段
将2.1中的灰度图Imggrey反相，得到Imginv, 。然后采用大小为3×3的所有元素均为1的卷积核对Imginv进行图像侵蚀操作(OpenCV中的erode函数)，最终得到去掉剪力墙与柱的图像Imgline。然后识别Imgline中的所有线段(OpenCV中的LSD函数)，得到原始线段集合L={l}，集合中每个线段元素用首尾端点的横纵坐标表示，即l=[x1,y1,x2,y2]，原始线段集合如图3（a）所示。 
由于原始线段集合中存在较多的重复线段，同时部分位置的线段缺失，因此需要将位于同一直线上的线段拼接起来。此外，在结构平面图中，剪力墙和梁是通过双实线表达的，而在最终的结构数字化表征中，剪力墙和梁存储为抽象化的边，因此需要识别双实线的中轴线位置和宽度，最终得到如图3（b）所示的单线集合。
 
图3  线段的识别、拼接和融合
Fig.3 The line segment recognition, splicing and fusion

为此，将原始线段集合按角度分类，线段的角度按式(1)计算
	 	(1)
分类的阈值设置为0，若两条线段的角度之差的绝对值小于0，则将二者归为一类，这样可以在误差允许的范围内将平行线段归为一类P。为了统一操作，为每一个平行线段类P中建立局部坐标系，坐标系的水平轴和线段平行，计算该平行线段类中P所有线段的局部坐标[x1’, y1’, x2’, y2’]：
	 	(2)
其中T()为坐标转换矩阵, 按式(3)定义，为该平行线段类中各线段的角度
	 	(3)
局部坐标系中线段的首尾端点纵坐标相等y1’= y2’，并且如果x1’> x2’，则调换x1’和x2’的位置，以保证x1’< x2’。
将该平行线段类按照局部纵坐标y1’分类，分类阈值为w0，若两条线段的y1’绝对值之差小于w0，则将二者归为一共线类C。此分类阈值的物理含义为剪力墙和梁的宽度像素值，实际操作中取稍大于剪力墙和梁的宽度像素值即可。将每个共线类C中的线段按首端点的横坐标x1’从小到大排序，然后从头按顺序遍历该共线类C中所有线段，继续对共线类C分类，分类规则为：对于第i条线段，将其和第i-1条线段比较，若满足式(4)，则将第i条线段归入第i-1条线段所在的线段类S中，否则，新建一个线段类S，其元素为第i条线段。
	 	(4)
式中 为第i条线段的首端点横坐标， 为第i-1条线段的尾端点横坐标，b0为分类阈值，其物理含义为柱宽度的像素值，实际操作中可取比柱宽度像素值稍大即可。
将线段类S中的线段拼接成为一个线段 ,并计算该线段的宽度w(s)和在全局坐标系中的角度(S)：
	 	(5)
最后计算线段S的全局坐标 ：
	 	(6)
式中 为坐标转换矩阵的转置。
2.3 线段相交与交点聚合
在经2.2拼接与融合得到新的线段集合后，遍历所有非平行的线段组合(l(i), l(j))，判断二者是否相交，如果相交，则求出交点坐标p=(xij, yij)，同时将该交点的放入线段l(i)和线段l(j))各自的交点集合I (i)和I (j)中。判断两个线段相交以及求出交点坐标的方式如下所述：
由于前述识别线段和融合线段的误差，原本图中相交的线段经过识别后可能不再相交，因此首先将l(i) 和l(j)两端均延长长度d，延长后的两线段首尾端点表示为 和 ,以l(i)为例，计算方式如式(7)所示：
	 	(7)
式中l为线段的长度。若两个延长后的线段满足式(8)中的两个不等式，则两线段相交。
                 (8)
按式(9)求出交点坐标(xij, yij)
	 	(9)
2.4建立无向图数字化表征
遍历所有交点，在空白图像Imgpoint上以交点p为圆心绘制半径为r0的填充圆，并将该图像和第一步得到的代表剪力墙和柱的填充多边形图像Imgsolid相交，若相交后图像非空白图像，则说明交点p处有柱或者剪力墙的暗柱，交点p可归类为柱节点，否则交点p归类为非柱节点。
遍历所有交点，按第1节所述的数据格式建立无向图的节点集合V，每个节点vV的节点特征为(x, y, c)，其中x和y是节点的坐标，c是节点的类别。遍历所有线段l(i)，并依序遍历线段l(i) 对应的有序交点集合I (i)={v1,v2,…,vn}，将e=(vj,vj+1)作为边建立起无向图的边集合E。
